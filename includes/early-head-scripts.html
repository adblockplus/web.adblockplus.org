<script>(()=>{

const scriptTime = parseInt(performance.now(), 10);

const query = new URLSearchParams(window.location.search);

/**
 * @namespace
 * @prop {object} query - global reference to initial window.location.search URL Search Params
 * @prop {object} api - functions provided to third parties
 * @prop {object} strings - localised strings injected via script
 * @prop {object} settings - shared settings injected via script
 */
const adblock = window.adblock = {
  scriptTime,
  query,
  api: {},
  strings: {},
  settings: {
    detectedOperatingSystem: navigator.userAgent.includes("Windows NT") ? "windows"
      : navigator.userAgent.includes("iPhone") || navigator.userAgent.includes("iPad") ? "ios"
      : navigator.userAgent.includes("Macintosh") ? "mac"
      : navigator.userAgent.includes("Linux") ? "linux"
      : "other",
    detectedBrowser: /opera|opr\//i.test(navigator.userAgent) ? "opera"
      : /SamsungBrowser/i.test(navigator.userAgent) ? "samsung"
      : /\sedg\/|edg([ea])/i.test(navigator.userAgent) ? "edge"
      : /firefox|iceweasel/i.test(navigator.userAgent) ? "firefox"
      : /chrome|chromium/i.test(navigator.userAgent) ? "chrome"
      : /safari|applewebkit/i.test(navigator.userAgent) ? "safari"
      : "other",
  },
};

const ALPHANUM = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";

/** generate sudo-random id */
adblock.uid = function uid(length = 32) {
  return [...Array(length)].map(() => ALPHANUM[Math.floor(Math.random() * ALPHANUM.length)]).join("");
}

/** browsing session uid */
adblock.sid = adblock.query.get("sid") || adblock.uid();

/** create an object from url params **/
adblock.URLSearchObject = function URLSearchObject(search) {
  const params = new URLSearchParams(search);
  return params.entries().reduce((object, entry) => {
    const [key, value] = entry;
    if (object.hasOwnProperty(key)) {
      if (Array.isArray(object[key])) object[key].push(value);
      else object[key] = [object[key], value];
    } else {
      object[key] = value;
    }
    return object;
  }, {});
}

const urlParamsJSON = JSON.stringify(adblock.URLSearchObject(location.search));

/** record data/activity via access log entry */
adblock.log = function log(event, data = {}) {
  try {
    const hardcoded = {
      logVersion: "2.1.0",
      event: event,
      sid: adblock.sid,
      pagePath: location.pathname,
      urlParams: urlParamsJSON,
    };
    const params = new URLSearchParams();
    for (const property in data) {
      if (hardcoded.hasOwnProperty(property)) console.error(`adblock.log() recieved data with reserved property: ${property}`);
      if (data[property] == null || data[property] == undefined) continue;
      params.set(property, data[property]);
    }
    for (const property in hardcoded) {
      params.set(property, hardcoded[property]);
    }
    return fetch(`/access?${params.toString()}`);
  } catch (error) {
    console.error("adblock.log", event, data, error);
  }
}

/**
 * @param {string} source - Where did the error come from?
 * @param {Error} error - The Error that was thrown
 * @returns {Promise}
 */
adblock.logScriptError = function logScriptError(source, error) {
  return adblock.log("script-error", {
    source,
    message: error.message,
    stack: error.stack,
    browser: adblock.settings.detectedBrowser,
    os: adblock.settings.detectedOperatingSystem,
    ABPInstalled: !!adblock.adblockPlus,
    ABPPremium: !!adblock.adblockPlus?.isPremium,
    ABPVersion: adblock.adblockPlus?.version,
  });
}

/**
 * @param {string} source - Where did the rejection come from?
 * @param {Object} rejection
 * @param {string} rejection.reason - Categorize why the rejection occurd by name e.g. (response|timeout)
 * @param {string} rejection.status - The HTTP status that was returned, if relevant
 * @param {Object|string} rejection.response - The response data that we recieved from the server (must be JSON stringifyable)
 * @returns {Promise}
 */
adblock.logServiceError = function logServiceError(source, rejection) {
  return adblock.log("service-error", {
    source,
    reason: rejection?.reason,
    status: rejection?.status,
    response: JSON.stringify(rejection?.response),
    browser: adblock.settings.detectedBrowser,
    os: adblock.settings.detectedOperatingSystem,
    ABPInstalled: !!adblock?.adblockPlus,
    ABPPremium: !!adblock?.adblockPlus?.isPremium,
    ABPVersion: adblock?.adblockPlus?.version,
  });
}

/** global general error handling and logging function */
adblock.handleError = function handleError({name, message, context, handler}) {
  if (handler) handler({name, message, context});
  else if (message) alert(message);
  console.error(name, message, context);
  let shareableContext;
  try { shareableContext = JSON.stringify(context); }
  catch (error) {}
  adblock.log("error", {name, shareableContext})
}

const injectionCallbacks = {};

/** 
 * Call a callback after an extension injects data into the page
 * (or immediately if the extension has already injected data into the page)
 */
adblock.afterExtensionInjection = function afterExtensionInjection(extensionName, callback) {
  if (adblock[extensionName]) return callback();
  if (!injectionCallbacks[extensionName]) injectionCallbacks[extensionName] = [];
  injectionCallbacks[extensionName].push(callback);
}

adblock.afterAdblockPlusDetected = callback => adblock.afterExtensionInjection("adblockPlus", callback);

function handleExtensionInjection(extensionName, extensionId) {
  try {
    adblock[extensionName] = JSON.parse(document.documentElement.dataset[extensionId]);
    if (injectionCallbacks[extensionName])
      injectionCallbacks[extensionName].forEach(callback => callback());
  } catch (error) {
    const context = {};
    context[extensionId] = document.documentElement.dataset[extensionId];
    adblock.handleError({name: "parse-extension-injection", context});
  }
}

function observeExtensionInjection(extensionName, extensionId) {
  if (document.documentElement.dataset.hasOwnProperty(extensionId)) {
    handleExtensionInjection(extensionName, extensionId);
  } else {
    const observer = new MutationObserver(() => {
      if (document.documentElement.dataset.hasOwnProperty(extensionId)) {
        handleExtensionInjection(extensionName, extensionId);
        observer.disconnect();
      }
    });
    observer.observe(document.documentElement, {attributes: true});
  }
}

observeExtensionInjection("adblock", "adblockExtensionInfo");
observeExtensionInjection("adblockPlus", "adblockPlusExtensionInfo");

// Temporarily measuring the time it takes for Adblock Plus to inject
// information into adblockplus.org so that we can consider it in our UX
adblock.afterAdblockPlusDetected(() => {
  const injectionTime = parseInt(performance.now(), 10);
  adblock.log("injection-time", {
    scriptTime,
    injectionTime,
    version: adblock.adblockPlus.version,
    browser: adblock.settings.detectedBrowser,
    operatingSystem: adblock.settings.detectedOperatingSystem,
  });
});

})()</script>

<!-- settings injected via cms -->
<? include inline-settings ?>